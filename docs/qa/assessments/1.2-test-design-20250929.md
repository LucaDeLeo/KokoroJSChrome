# Test Design: Story 1.2 - Create KokoroEngine Plugin

**Date:** 2025-09-29
**Designer:** Quinn (Test Architect)
**Story:** 1.2 - Create KokoroEngine Plugin

## Test Strategy Overview

- **Total test scenarios:** 23
- **Unit tests:** 9 (39%)
- **Integration tests:** 11 (48%)
- **E2E tests:** 3 (13%)
- **Priority distribution:** P0: 10, P1: 9, P2: 4

### Strategy Rationale

This story wraps existing, proven TTS code in a plugin architecture. The testing strategy emphasizes:
1. **Code preservation verification** (P0) - ensuring original code remains unchanged
2. **Integration testing** (primary focus) - validating plugin interactions with event pipeline
3. **Performance validation** (P0) - meeting sub-50ms synthesis latency requirement
4. **Audio quality preservation** (P0) - ensuring byte-for-byte or perceptual equivalence

The higher ratio of integration tests (48%) aligns with the story's focus on wrapping and integrating existing components rather than implementing new business logic.

---

## Test Scenarios by Acceptance Criteria

### AC1: Create KokoroEngine plugin that wraps existing TTS files

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-001 | Unit | P1 | Plugin metadata validation (id, stage, version) | Pure validation logic - fast feedback |
| 1.2-INT-001 | Integration | P0 | Plugin loads all TTS modules successfully | Critical component initialization - verifies file structure |
| 1.2-INT-002 | Integration | P1 | Plugin exports correct API surface | Validates public interface contract |

**Coverage:** 3 scenarios (1 unit, 2 integration)

---

### AC2: Preserve kokoro.js, phonemize.js, voices.js, semantic-split.js exactly as-is

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-002 | Unit | P0 | File hash comparison of original vs. wrapped TTS files | Ensures byte-for-byte preservation - regression prevention |
| 1.2-INT-003 | Integration | P0 | Original TTS functions callable through plugin wrapper | Validates zero modification to working code |
| 1.2-E2E-001 | E2E | P0 | Full synthesis flow produces identical output to original web app | Critical validation of code preservation at system level |

**Coverage:** 3 scenarios (1 unit, 1 integration, 1 E2E)

**Risk Mitigation:** These tests directly address the risk of breaking working TTS code during wrapper implementation.

---

### AC3: Implement plugin interface: init(), process(), synthesize()

#### init() Method

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-003 | Unit | P1 | init() accepts eventBus and pal parameters | Simple parameter validation |
| 1.2-INT-004 | Integration | P0 | init() registers plugin with event bus successfully | Critical initialization flow |
| 1.2-INT-005 | Integration | P1 | init() handles missing/invalid dependencies gracefully | Error handling validation |

#### process() Method

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-004 | Unit | P1 | process() validates TTSEvent structure | Input validation logic |
| 1.2-INT-006 | Integration | P0 | process() routes events to synthesis pipeline | Core event flow - multi-component interaction |
| 1.2-INT-007 | Integration | P1 | process() handles malformed events with error response | Error path validation |

#### synthesize() Method

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-005 | Unit | P1 | synthesize() validates input options schema | Pure validation logic |
| 1.2-INT-008 | Integration | P0 | synthesize() invokes kokoro.js synthesis correctly | Critical TTS wrapping logic |
| 1.2-INT-009 | Integration | P1 | synthesize() returns AudioResult with correct format | Output contract validation |
| 1.2-INT-010 | Integration | P1 | synthesize() handles synthesis errors and returns structured error | Error handling at component boundary |

#### Voice Management (listVoices, setVoice)

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-006 | Unit | P2 | listVoices() returns array of valid KokoroVoice objects | Simple data structure validation |
| 1.2-INT-011 | Integration | P1 | setVoice() updates voice selection in underlying TTS engine | Validates interaction with voices.js |

#### Model Management (loadModel, unloadModel, getModelStatus)

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-INT-012 | Integration | P0 | loadModel() initializes ONNX model successfully | Critical resource initialization |
| 1.2-INT-013 | Integration | P1 | unloadModel() releases model resources and cleans up memory | Resource cleanup validation |
| 1.2-UNIT-007 | Unit | P2 | getModelStatus() returns correct state enum | Simple state query logic |

#### Performance Tuning (setQuality, setBatchSize)

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-UNIT-008 | Unit | P2 | setQuality() accepts valid quality enum values | Parameter validation |
| 1.2-UNIT-009 | Unit | P2 | setBatchSize() validates numeric range | Parameter validation |

**Coverage:** 14 scenarios (7 unit, 7 integration)

---

### AC4: Bundle transformers.js and dependencies locally (no CDN)

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-INT-014 | Integration | P0 | Webpack bundle analysis shows zero external CDN URLs | Critical bundling requirement validation |
| 1.2-INT-015 | Integration | P0 | Plugin loads transformers.js from local bundle | Validates offline capability |
| 1.2-INT-016 | Integration | P1 | Total bundle size < 50MB threshold | Performance/size requirement |

**Coverage:** 3 scenarios (3 integration)

**Note:** These are integration tests because they validate build tooling output and multi-component bundling, not isolated logic.

---

### AC5: Plugin responds to TTSEvent and produces audio output

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-INT-017 | Integration | P0 | Plugin receives TTSEvent and emits audio response | Core event flow validation |
| 1.2-E2E-002 | E2E | P1 | End-to-end synthesis from text input to audio output | Complete user journey validation |

**Coverage:** 2 scenarios (1 integration, 1 E2E)

---

## Integration Verification Coverage

### IV1: Original TTS code unchanged and working

**Covered by:**
- 1.2-UNIT-002 (file hash comparison)
- 1.2-INT-003 (function callability)
- 1.2-E2E-001 (system-level synthesis)

### IV2: Plugin processes events through pipeline successfully

**Covered by:**
- 1.2-INT-006 (event routing)
- 1.2-INT-017 (event response flow)
- 1.2-E2E-002 (end-to-end pipeline)

### IV3: Performance metrics show synthesis latency < 50ms for short text

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.2-INT-018 | Integration | P0 | Synthesis of 100-char text completes under 50ms | Critical performance requirement |
| 1.2-E2E-003 | E2E | P1 | End-to-end pipeline latency monitoring shows stage times | Performance observability validation |

**Coverage:** 2 scenarios (1 integration, 1 E2E)

### IV4: Voice quality identical to original web app

**Covered by:**
- 1.2-E2E-001 (byte-for-byte audio comparison)

**Manual Testing Fallback:** If byte-for-byte comparison is not feasible, conduct user acceptance testing with 3+ testers for perceptual quality validation.

---

## Test Distribution Summary

### By Acceptance Criteria

| AC | Unit | Integration | E2E | Total |
|---|---|---|---|---|
| AC1 | 1 | 2 | 0 | 3 |
| AC2 | 1 | 1 | 1 | 3 |
| AC3 | 7 | 7 | 0 | 14 |
| AC4 | 0 | 3 | 0 | 3 |
| AC5 | 0 | 1 | 1 | 2 |

### By Priority

| Priority | Count | Percentage | Focus Area |
|---|---|---|---|
| P0 | 10 | 43% | Core functionality, code preservation, performance |
| P1 | 9 | 39% | Error handling, API contracts, pipeline integration |
| P2 | 4 | 17% | Configuration validation, state queries |
| P3 | 0 | 0% | N/A |

### Test Pyramid Health

```
        E2E (3)    13%  ← Appropriate - validates critical paths
      /        \
    Integration (11) 48%  ← Primary focus - plugin integration
   /              \
  Unit (9)         39%  ← Supporting - validates isolated logic
```

**Assessment:** Healthy distribution with emphasis on integration testing appropriate for wrapper/adapter pattern implementation.

---

## Recommended Execution Order

### Phase 1: Fast Feedback (P0 Unit Tests)
1. 1.2-UNIT-002 (file preservation check)

### Phase 2: Critical Integration (P0 Integration)
2. 1.2-INT-001 (plugin loads modules)
3. 1.2-INT-003 (TTS functions callable)
4. 1.2-INT-004 (init registration)
5. 1.2-INT-006 (process routing)
6. 1.2-INT-008 (synthesize invocation)
7. 1.2-INT-012 (loadModel)
8. 1.2-INT-014 (bundle analysis)
9. 1.2-INT-015 (local transformers.js)
10. 1.2-INT-017 (event response)
11. 1.2-INT-018 (performance validation)

### Phase 3: Critical End-to-End (P0 E2E)
12. 1.2-E2E-001 (audio quality preservation)

### Phase 4: P1 Tests
13. All P1 unit tests (1.2-UNIT-001, 003, 004, 005)
14. All P1 integration tests (1.2-INT-002, 005, 007, 009, 010, 011, 013, 016)
15. All P1 E2E tests (1.2-E2E-002, 003)

### Phase 5: P2 Tests (Time Permitting)
16. Configuration validation tests (1.2-UNIT-006, 007, 008, 009)

---

## Risk Coverage Analysis

### High-Risk Areas Addressed

| Risk | Test Scenarios | Mitigation Strategy |
|---|---|---|
| Breaking working TTS code | 1.2-UNIT-002, INT-003, E2E-001 | Multi-level validation from file hashes to full synthesis |
| Performance degradation | 1.2-INT-018, E2E-003 | Direct latency measurement against 50ms threshold |
| Bundle size explosion | 1.2-INT-016 | Explicit 50MB threshold validation |
| Event pipeline failures | 1.2-INT-004, 006, 017 | Complete event flow testing |
| Memory leaks | 1.2-INT-013 | Cleanup validation for model unloading |

### Coverage Gaps

**None identified.** All ACs and IVs have comprehensive test coverage at appropriate levels.

---

## Quality Gate Criteria

This test design recommends the following gate criteria:

- **PASS Criteria:**
  - All P0 tests pass (10 tests)
  - ≥90% of P1 tests pass (8/9 tests)
  - No critical performance regressions
  - Audio quality validation confirms preservation

- **CONCERNS Criteria:**
  - 1-2 P0 test failures with documented workarounds
  - Performance within 10% of threshold (55ms)
  - P1 test pass rate 70-89%

- **FAIL Criteria:**
  - ≥3 P0 test failures
  - Performance >110% of threshold (>55ms)
  - Audio quality degradation detected
  - Original TTS code modified

---

## Test Maintenance Considerations

### Stable Tests (Low Maintenance)
- File hash comparisons (1.2-UNIT-002)
- Bundle analysis (1.2-INT-014)
- API surface validation (1.2-INT-002)

### Potentially Brittle Tests
- E2E audio comparison (1.2-E2E-001) - may need tolerance thresholds
- Performance tests (1.2-INT-018) - environment-dependent

### Recommended Practices
- Use deterministic test inputs for audio synthesis
- Mock time-dependent operations where possible
- Establish baseline audio fingerprints for comparison
- Document environment requirements for performance tests

---

## Notes for Implementation

1. **Test Data Requirements:**
   - Sample text inputs of varying lengths (10, 50, 100, 500 chars)
   - Baseline audio outputs from original web app
   - SHA-256 hashes of original TTS files

2. **Test Environment Setup:**
   - In-memory event bus for integration tests
   - Local model files for testing (avoid network calls)
   - Performance measurement harness with microsecond precision

3. **Continuous Monitoring:**
   - Track synthesis latency trends
   - Monitor bundle size growth over time
   - Alert on test execution time increases

4. **Integration with CI/CD:**
   - P0 tests run on every commit (gate for PR merge)
   - P1 tests run on PR creation
   - P2 tests run nightly
   - E2E tests run pre-release

---

## Appendix: Test Scenario Details

### Key Test Patterns

**Pattern 1: Hash-Based Code Preservation**
```javascript
// 1.2-UNIT-002 implementation example
test('TTS files unchanged from original', () => {
  const originalHashes = {
    'kokoro.js': 'abc123...',
    'phonemize.js': 'def456...',
    'voices.js': 'ghi789...',
    'semantic-split.js': 'jkl012...'
  }

  Object.entries(originalHashes).forEach(([file, hash]) => {
    expect(computeFileHash(`src/${file}`)).toBe(hash)
  })
})
```

**Pattern 2: Audio Quality Comparison**
```javascript
// 1.2-E2E-001 implementation example
test('Synthesis produces identical audio to original', async () => {
  const testInput = { text: 'Hello world', voice: 'af_bella' }
  const originalAudio = await originalWebApp.synthesize(testInput)
  const pluginAudio = await kokoroPlugin.synthesize(testInput)

  expect(pluginAudio.buffer).toEqual(originalAudio.buffer)
  // OR with tolerance for non-deterministic encoding
  expect(audioSimilarity(pluginAudio, originalAudio)).toBeGreaterThan(0.99)
})
```

**Pattern 3: Performance Measurement**
```javascript
// 1.2-INT-018 implementation example
test('Synthesis completes under 50ms for short text', async () => {
  const startTime = performance.now()
  await kokoroPlugin.synthesize({
    text: 'X'.repeat(100),
    voice: 'af_bella'
  })
  const duration = performance.now() - startTime

  expect(duration).toBeLessThan(50)
})
```

---

**End of Test Design Document**